---
layout: post
title: Pintos - fd table 구조 고르기
date: 2025-11-21 01:08:00
description:
tags: Pintos
categories: 크래프톤 정글
---

## fd table 뭐가 좋을까?

fd table은  ADT처럼 내부 구현은 상관없이 `fd → file` 매핑만 잘되면 상관없다. 그렇다 보니 사람들마다 짜는 방식이 다를 수 있고 실제로 우리 조원 세명 모두 조금씩 다른 fd table을 구현했다.  
조원들의 fd table을 보며 무엇이 좋은 방법일까 더 좋은 방법은 없을까 고민한 이야기를 해보겠다.

## 조원들의 구조

조원들이 짠 구조를 A, B, C라고 칭하겠다.
file의 구조체는 `struct file` 이다.
fd table이 동적 확장이 가능한 구조로 구현을 하였다.
대표적으로 아래 세개 함수를 중심으로 설명 하겠다.

- `fd_allocate()`:  file를 받아 fd table에 넣고 넣은 위치를 반환하는 함수
- `fd_close()`: fd를 받아 해당 fd를 비우는 함수
- `fd_expand()`: fd table 크기가 부족할 경우 확장하는 함수

### A 구조

매우 평범한 구조이다. file배열 `struct file**` 과 관리를 위한 `table_size` 를 가진다.
`fd_allocate()` 를 할 경우 2부터(stdin, stdout을 제외한)  `table_size` 순회를 하며 비어있는 fd를 찾는다. 찾을 경우 fd를 할당하고 해당 fd를 return하고 찾지 못할 경우, 즉 크기가 부족한 경우 크기를 늘려 위 과정을 다시 시도한다.

`fd_expand()` 같은 경우 현재보다 큰 파일 테이블을 만들고 복사하는 형식으로 관리한다.

### B 구조

A구조에 `fd_next` 라는 다음 파일이 등록될 번호를 저장하는 변수를 사용하는 구조이다.
`fd_allocate()` 시 `fd_next` 를 이용해 바로 할당하고 `fd_next` 부터 `table_size` 까지 순회하며 다음 `fd_next` 를 찾는다. 찾지 못할 경우 A구조와 동일하게 확장을 한 후 다시 시도한다.

`fd_close()` 를 하는 위치가 `fd_next` 보다 작을 경우 `fd_next` 를 업데이트 해준다.

확장하는 방식은 A구조와 동일하다.

### C 구조

B구조와 같이 `fd_next` 를 가지지만 특이한 점이 배열들을 기차처럼 이어 붙히는 형식이다.
`[64] - [64] - [64]` 링크드 리스트로 배열들을 묶어서 확장을 할때 복사 붙혀넣기 하는 과정없이 할당만으로 확장을 하는 방식이다. 순회 하는방식이 링크드 리스트이기 때문에 A, B구조와 조금 다르다.

## 무슨 구조가 좋을까?

A, B, C 구조 중에 뭐가 제일 좋을까? A구조 보다는 B구조가 더 좋다고 생각한다. `fd_next` 를 추가하는 것으로 보편적인 탐색 범위를 많이 줄일 수 있다. C구조같은 경우 확장을 복사 없이하여 좋아 보였지만 순회 하는 방식이 복잡하다는 생각이 들었다.  
조원들끼리 얘기를 하다가 저번 주 주간 발표 때 들었던 비트맵이 떠올랐다. 비트맵으로 fd table을 관리하면 좋을 것 같다는 생각이 들었다.


## 비트맵을 이용한 fd table

fd table 중에 할당이 안된 가장 작은 fd를 구하는데에는 비트맵 만한게 없다고 생각했다.
B구조에서 비트맵 방식을 더하는 방식으로 설계하니. 이를 통해 `fd_next` 를 연산 비용을 대폭 줄일 수 있었다.

long타입 배열을 비트맵으로 활용하여 한번에 64개의 fd를 탐색할 수 있었다. 
순회 시 64개 단위로 탐색하며 비어있는 fd를 빠르게 찾는 방식이다. 기존이라면 100개의 fd를 탐색할 때 100번 순회를 해야했지만 비트맵을 이용하면 최대 2번의 순회로 끝낼 수 있다.

찾아보니 리눅스도 비트맵 방식을 사용하고 있어 뭔가 기분이 좋았다 ㅋㅋ

## 코드는 두드릴수록 단단해진다

코드는 두드릴수록 단단해지는 것 같다. 이번에는 구조가 다 달라 서로의 생각이 많이 부딪쳤고 이 과정에서 더 좋은 코드가 나오는 것을 체감했다. pintos 과제는 같은 과제를 구현하고 merge를 해야해서 서로의 코드 중 하나를 고르는 곤란한 상황도 많이 나오지만 그런 과정 속에서 단단한 코드를 찾는 것이 pintos주차 중에 가장 중요한 것 이라 생각한다.